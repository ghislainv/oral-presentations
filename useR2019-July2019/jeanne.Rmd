

## Models definition

### Models definition

#### Data and parameters : 
- Response variable: $Y=(y_{i})_{i=1,\ldots,nsite}$ such as :

$$y_{i}=\begin{cases}
0 & \text{ if the species is absent on the site $i$}\\
1 &  \text{ if the species is present on the site $i$.}
\end{cases}$$

- Explanatory variables : $X=(X_i)_{i=1,\ldots,nsite}$ avec $X_i=(x_i^1,\dots,x_i^p)'\in \mathbb{R}^p$ where $p$ is the number of bioclimatic variables considered for each site $i$.

\vspace{0.2cm}

- Species fixed effect :  $\beta_{0}$ and $\beta=(\beta_{1},\ldots,\beta_{p})'$, the intercept and regression coefficients which are assumed to have prior distribution $\mathcal{N}(0,10^6)$.

### Models definition
#### Model 1 : hSDM with logit link function
\begin{center}
$\mathrm{logit}(\theta_{i}) = \beta_{0} + X_i'\beta$
\end{center}
\vspace{0.2cm}

- Link function logit : $\mathrm{logit} : p \rightarrow =\log(p)-\log(1-p)$.
\vspace{0.2cm}
- $y_{i} \sim \mathrm{Bin}(n_i,\theta_{i})$ with $n_i$ the number of visits for site $i$.

#### Model 2 : hSDM with probit link function 
\begin{center}
$\mathrm{probit}(\theta_{i}) = \beta_{0} + X_i'\beta$
\end{center}
\vspace{0.2cm}

- Link function probit: $\mathrm{probit} : q \rightarrow \Phi^{-1}(q)$ where $\Phi$ correspond to the $\mathcal{N}(0,1)$ cumulative distribution function. 
\vspace{0.2cm}
- Latent variable $z_{i} = \beta_0 + X_i'\beta + \epsilon_{i}$, with $\epsilon_{i} \sim \mathcal{N}(0,1)$ and such as :
$$y_{i}=\begin{cases}
1 & \text{ if } z_{i} > 0 \\
0 &  \text{ otherwise.}
\end{cases}$$

- We easily shown that $y_{i}| z_{i} \sim \mathcal{B}ernouilli(\theta_{i})$. 

## Inference method 
### Model 1 : Gibbs sampler with Metropolis algorithm 
#### Gibbs sampler :
Use to get sample of random variable, $Z=(Z_1,Z_2,Z_3)$ for example,
with known probability distributions $\uppi_i(z_i)$ for $i=1,2,3$. 

\vspace{0.2cm}

- **Initialisation** : $z^{(0)}= 0_{\mathbb{R}^3}$.

\vspace{0.2cm}

- **Iteration t** : Generate $z^{(t)}$ as follows :
\vspace{0.2cm}
* $z_1^{(t)} \sim \uppi_1\left(z_1 \ | z_2^{(t-1)},z_3^{(t-1)}\right)$
\vspace{0.1cm}
* $z_2^{(t)} \sim \uppi_2\left(z_2 \ | \ z_1^{(t)}, z_3^{(t-1)}\right)$
\vspace{0.1cm}
* $z_3^{(t)} \sim \uppi_3\left(z_3 \ | \ z_1^{(t)}, z_2^{(t)}\right)$  

\vspace{0.2cm}  

So we need conditional posterior distributions of betas which are not explicitly calculable in this case. 

### Model 1 : Gibbs sampler with Metropolis algorithm 
#### Metropolis Hastings algorithm :  
Use to generate betas according to an estimation of their conditional posterior distributions.

- **Initialisation** : $z^{(0)}= 0_{\mathbb{R}^3}$.
\vspace{0.2cm}
- **Iteration t** : 
\vspace{0.2cm}

* Generate $z^* \sim q(z^{(t-1)},.)$, as symetric proposal distribution $q(z^{(t-1)},.)$ we have chosen $\mathcal{N}(z^{(t-1)},1)$.
\vspace{0.1cm}
* Calculate the acceptance probability : $$\alpha = min\left(1,\frac{\uppi(z^*)}{\uppi(z^{(t-1)})}\right)$$.
* Retain $${z}^{(t)} =  
\begin{cases} 
z^* & \text{with probability } \alpha  \\
z^{(t-1)} & \text{with probability } 1-\alpha. \\
\end{cases}$$

### Model 2 : Gibbs sampler with conjugate priors
We use conjugate priors in a Gibbs sampler to estimate posterior distribution of parameters with the following proposition :

#### Proposition 1 
$$\begin{cases} 
Y \ | \ \beta &\sim \mathcal{N}_n ( X\beta, I_n) \\
\beta  &\sim \mathcal{N}_p (m,V)
\end{cases}
\Rightarrow \begin{cases}
\beta|Y &\sim \mathcal{N}_p (m^*,V^*) \text{ with }  \\
m^* &= (V^{-1} + X'X)^{-1}(V^{-1}m + X'Y)\\
V^*&=(V^{-1} + X'X)^{-1} 
\end{cases}$$.

## Evaluation of their efficiency on simulated dataset 
### Model 1 : hSDM with logit link function 
\bcols

\bcol{0.5\textwidth}
\centering \includegraphics[height=0.4\textheight, width=0.8\textwidth]{figs/results-mod1-1.pdf}  
\includegraphics[height=0.4\textheight, width=0.8\textwidth]{figs/results-mod1-2.pdf}
\ecol

\bcol{0.5\textwidth}
\centering \includegraphics[height=0.4\textheight, width=\textwidth]{figs/results-mod1-4.pdf}   
\includegraphics[height=0.45\textheight, width=\textwidth]{figs/results-mod1-3.pdf} 
\ecol
\ecols

### Model 2 : hSDM with probit link function 

\bcols

\bcol{0.5\textwidth}
\centering \includegraphics[height=0.4\textheight, width=0.8\textwidth]{figs/results-mod2-1.pdf}  
\includegraphics[height=0.4\textheight, width=0.8\textwidth]{figs/results-mod2-2.pdf}
\ecol

\bcol{0.5\textwidth}
\centering 
\includegraphics[height=0.4\textheight, width=0.5\textwidth]{figs/results-mod2-3.pdf} \ \includegraphics[height=0.4\textheight, width=0.5\textwidth]{figs/results-mod2-4.pdf} 
\vspace{0.15cm}
\includegraphics[height=0.4\textheight, width=\textwidth]{figs/results-mod2-5.pdf}
\ecol
\ecols

## Compilation time of Gibbs sampler in R or in C++ with GSL and R draws

### Compilation time of Gibbs sampler in R or in C++ with GSL and R random draws to fit model 1 

#### Compilation times in secondes 

```{r compilation-time, echo = FALSE}
library(knitr)
load("Code/draws.RData")
result <- data.frame(matrix(NA,1,3),row.names=c("Compilation time in secondes"))
colnames(result) <- c("GSL draws","R draws","R function")
result[1,] = c(T_gsl_draws, T_R_draws, T_R)
kable(result, digits =1, format = "latex")

```

\begin{block}{GSL radom draws in Rcpp}
\lstinputlisting[language=C++, firstline=1, lastline=2]{Code/draws.cpp} 
\end{block}
\begin{block}{R random draws in Rcpp}
\lstinputlisting[language=C++, firstline=3, lastline=4]{Code/draws.cpp} 
\end{block}

# Comparison between packages boral and jSDM 
## Model definition 
### Definition of the joint Species Distribition Model used : 
$$ \mathrm{probit}(\theta_{ij}) =\alpha_i + \beta_{0j}+X_i\beta_j+ W_i'\lambda_j $$

- Link function probit: $\mathrm{probit}: q \rightarrow \Phi^{-1}(q)$ where $\Phi$ correspond to the $\mathcal{N}(0,1)$ cumulative distribution function. 

- Response variable: $Y=(y_{ij})^{i=1,\ldots,nsite}_{j=1,\ldots,nspecies}$ with :
$$y_{ij}=\begin{cases}
0 & \text{ if species $j$ is absent on the site $i$}\\
1 &  \text{ if species  $j$ is present on the site $i$.}
\end{cases}$$
- Latent variable $z_{ij} = \alpha_i + \beta_{0j} + X_i'\beta_j + W_i'\lambda_j + \epsilon_{ij}$,  
with $\epsilon_{ij} \sim \mathcal{N}(0,1)$ and such that:
$$y_{ij}=\begin{cases}
1 & \text{if} \ z_{ij} > 0 \\
0 &  \text{otherwise.}
\end{cases}$$

It can be easily shown that: $y_{ij} \sim \mathcal{B}ernouilli(\theta_{ij})$. 

### Data and parameters 

- Explanatory variables : $X=(X_i)_{i=1,\ldots,nsite}$ avec $X_i=(x_i^1,\ldots,x_i^p) \in \mathbb{R}^p$ where $p$ is the number of bioclimatic variables considered for each site $i$.

- Species fixed effect :  $\beta_{0j}$ and $\beta_j=(\beta_j^1,\ldots,\beta_j^p)'$, the intercept and regression coefficients for each species $j$. We use a prior distribution $\mathcal{N}(0,10^6)$ for all betas. 

- Latent variables: $W_i=(W_i^1,\ldots,W_i^q)$ where $q$ is the number of latent variables considered, we assume that $W_i \sim \mathcal{N}(0,I_q)$.

- Species fixed effect on latent variables : $\lambda_j=(\lambda_j^1,\ldots, \lambda_j^q)'$. We use a prior distribution $\mathcal{N}(0,10)$ for all lambdas not concerned by constraints to 0 on upper diagonal and to strictly positive values on diagonal.

- Random site effect : $\alpha_i \sim \mathcal{N}(0,V_{\alpha})$.
- Variance of random site effect : $V_{\alpha} \sim \mathcal {IG}(\text{shape}=0.5, \text{rate}=0.005)$.

## Inference method 
### Inference method 
Gibbs sampler with conjugate prior to estimate conditional posterior distributions of parameters :

- jSDM's function jointly estimate betas and lambdas of each species by drawing them under a multivariate gaussian distribution configured according to proposition 1.  

- boral's function separately estimate betas and lambdas by drawing each parameter under gaussian distribution. 

- Estimation of random site effect variance using the following proposal : 
$$\begin{cases} 
x \ | \ \sigma^2 & \sim \mathcal{N}_n (\theta, \ \sigma^2I_n) \\
\sigma^2  & \sim \mathcal{IG} (a,b) \\
\theta & \text{ connu}
\end{cases} \Rightarrow 
\begin{cases}
\sigma^2|x \sim \mathcal{IG}(a',b') \text{ with } \\
a' = a + \frac{n}{2} \\ 
b' = \frac{1}{2}\sum\limits_{i=1}^n(x_i-\theta)^2 + b. 
\end{cases}$$


##  Compilation times and accuracy of estimated parameters
### Compilation times and accuracy of estimated parameters 
#### Compilation times in minuts on four real datasets and one simulated

```{r time}
load("Code/jSDM_boral_sim.RData")
load("Code/jSDM_boral_mosquito.RData")
load("Code/jSDM_boral_eucalypts.RData")
load("Code/jSDM_boral_frogs.RData")
load("Code/boral_fungi.RData")
load("Code/jSDM_fungi.RData")


result <- data.frame(matrix(NA,2,5),row.names=c("boral","jSDM "))
colnames(result) <- c("Simulated","Mosquito","Eucalypts","Frogs","Fungi")
result[1,]=c(T_boral_sim, T_boral_Mosquito, T_boral_Eucalypts, T_boral_Frogs, T_boral_Fungi)
result[2,]=c(T_jSDM_block_sim, T_jSDM_block_Mosquito, T_jSDM_block_Eucalypts, T_jSDM_block_Frogs, T_jSDM_block_Fungi)
kable(result, digits =1)
```

#### Root-Mean-Square Error (RMSE) for simulated data
\centering
```{r RMSE}
library(knitr)
result <- data.frame(matrix(NA,1,2),row.names=  c("RMSE"))
colnames(result) <- c("boral","jSDM")
result$boral <- RMSE_boral_sim
result$jSDM <- RMSE_jSDM_block_sim
kable(result, digits=1)
```

#### Obtained deviances with estimated parameters
```{r deviance}
library(knitr)
result <- data.frame(matrix(NA,2,5),row.names=c("boral", "jSDM"))
colnames(result) <- c("Simulated","Mosquito","Eucalypts","Frogs","Fungi")
result[1,] <- c(Deviance_boral_sim, Deviance_boral_Mosquito, Deviance_boral_Eucalypts, Deviance_boral_Frogs, Deviance_boral_Fungi)
result[2,] <- c( mean(mod_jSDM_block_sim$mcmc.Deviance),  mean(mod_jSDM_block_Mosquito$mcmc.Deviance),  mean(mod_jSDM_block_Eucalypts$mcmc.Deviance),  mean(mod_jSDM_block_Frogs$mcmc.Deviance),  mean(mod_jSDM_block_Fungi$mcmc.Deviance))
kable(result, digits =1)
```

## Comparison of estimated parameters by both packages 

### Comparison of estimated parameters by both packages 

#### Simulated dataset :300 sites and 100 species

\centering 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-simulation-1.pdf} \ \includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-simulation-2.pdf} \ 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-simulation-3.pdf}  
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-simulation-4.pdf} 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-simulation-5.pdf} 

### Comparison of estimated parameters by both packages 
#### Mosquito dataset : 167 sites and 16 species 
\centering 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-mosquito-1.pdf} \ 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-mosquito-2.pdf} \ 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-mosquito-3.pdf}  
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-mosquito-4.pdf} 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-mosquito-5.pdf} 

### Comparison of estimated parameters by both packages 
#### Eucalypts dataset : 458 sites and 12 species

\centering 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-Eucalypts-1.pdf} \ 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-Eucalypts-2.pdf} \ 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-Eucalypts-3.pdf}  
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-Eucalypts-4.pdf} 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-Eucalypts-5.pdf} 

### Comparison of estimated parameters by both packages 
#### Frogs dataset : 104 sites and 9 species

\centering 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-frogs-1.pdf} \ 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-frogs-2.pdf} \ 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-frogs-3.pdf}  
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-frogs-4.pdf} 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-frogs-5.pdf} 

### Comparison of estimated parameters by both packages 
#### Fungi dataset : 800 sites and 11 species

\centering 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-fungi-1.pdf} \ 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-fungi-2.pdf} \ 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-fungi-3.pdf}  
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-fungi-4.pdf} 
\includegraphics[height=0.4\textheight, width=0.3\textwidth]{figs/jSDM-boral-fungi-5.pdf} 